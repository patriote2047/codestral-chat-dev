import chalk from 'chalk';

export async function analyzeNextConfig(content) {
    try {
        // Essayer de parser le JSON, sinon cr√©er un objet √† partir de la cha√Æne
        let config;
        try {
            config = JSON.parse(content);
        } catch (e) {
            // √âvaluer la cha√Æne de mani√®re s√©curis√©e
            config = eval('(' + content + ')');
        }

        const report = {
            compiler: analyzeCompiler(config.compiler),
            experimental: analyzeExperimental(config.experimental),
            headers: analyzeHeaders(config.headers),
            rewrites: analyzeRewrites(config.rewrites),
            security: analyzeSecurityConfig(config),
            performance: analyzePerformanceConfig(config),
            optimization: analyzeOptimization(config)
        };

        return formatReport(report);
    } catch (error) {
        throw new Error(`[ERREUR D'ANALYSE NEXT.JS] ${error.message}`);
    }
}

function analyzeCompiler(compiler) {
    if (!compiler) return null;

    return {
        options: {
            styledComponents: compiler.styledComponents || false,
            emotion: compiler.emotion || false,
            reactRemoveProperties: compiler.reactRemoveProperties || false,
            removeConsole: compiler.removeConsole || false
        },
        optimization: {
            minify: !compiler.ignoreBuildErrors,
            sourceMap: compiler.sourceMap !== false
        }
    };
}

function analyzeExperimental(experimental) {
    if (!experimental) return null;

    const features = Object.entries(experimental).map(([feature, enabled]) => ({
        name: feature,
        enabled,
        risk: assessExperimentalRisk(feature)
    }));

    return {
        features,
        analysis: analyzeExperimentalRisks(features)
    };
}

function assessExperimentalRisk(feature) {
    const riskLevels = {
        'serverActions': 'HAUTE',
        'appDir': 'MOYENNE',
        'serverComponents': 'MOYENNE',
        'runtime': 'HAUTE'
    };

    return riskLevels[feature] || 'FAIBLE';
}

function analyzeExperimentalRisks(features) {
    const risks = [];
    const highRiskFeatures = features.filter(f => f.risk === 'HAUTE' && f.enabled);

    if (highRiskFeatures.length > 0) {
        risks.push({
            level: 'HAUTE',
            message: `Fonctionnalit√©s exp√©rimentales √† risque activ√©es: ${highRiskFeatures.map(f => f.name).join(', ')}`
        });
    }

    return risks;
}

function analyzeHeaders(headers) {
    if (!headers) return null;

    return {
        count: typeof headers === 'function' ? 'Dynamique' : Array.isArray(headers) ? headers.length : 0,
        security: analyzeSecurityHeaders(headers),
        cors: analyzeCorsHeaders(headers)
    };
}

function analyzeSecurityHeaders(headers) {
    const securityHeaders = [
        'Strict-Transport-Security',
        'Content-Security-Policy',
        'X-Frame-Options',
        'X-Content-Type-Options',
        'Referrer-Policy'
    ];

    const implemented = new Set();
    const missing = new Set(securityHeaders);

    if (Array.isArray(headers)) {
        headers.forEach(header => {
            header.headers?.forEach(h => {
                const headerName = h.key.toLowerCase();
                securityHeaders.forEach(sh => {
                    if (headerName === sh.toLowerCase()) {
                        implemented.add(sh);
                        missing.delete(sh);
                    }
                });
            });
        });
    }

    return {
        implemented: Array.from(implemented),
        missing: Array.from(missing)
    };
}

function analyzeCorsHeaders(headers) {
    if (!headers || !Array.isArray(headers)) return null;

    const corsHeaders = headers.filter(header => 
        header.headers?.some(h => 
            h.key.toLowerCase().includes('access-control')
        )
    );

    return {
        enabled: corsHeaders.length > 0,
        config: corsHeaders
    };
}

function analyzeRewrites(rewrites) {
    if (!rewrites) return null;

    const isFunction = typeof rewrites === 'function';
    const rules = Array.isArray(rewrites) ? rewrites : [];

    return {
        type: isFunction ? 'Dynamique' : 'Statique',
        count: isFunction ? 'Dynamique' : rules.length,
        analysis: analyzeRewriteRisks(rules)
    };
}

function analyzeRewriteRisks(rules) {
    const risks = [];

    if (!Array.isArray(rules)) return risks;

    const hasWildcards = rules.some(rule => 
        rule.source?.includes('*') || rule.destination?.includes('*')
    );

    if (hasWildcards) {
        risks.push({
            level: 'MOYENNE',
            message: 'Utilisation de wildcards dans les r√®gles de r√©√©criture peut impacter les performances'
        });
    }

    const hasExternalRedirects = rules.some(rule => 
        rule.destination?.startsWith('http') || rule.destination?.startsWith('//')
    );

    if (hasExternalRedirects) {
        risks.push({
            level: 'HAUTE',
            message: 'Redirections vers des domaines externes d√©tect√©es'
        });
    }

    return risks;
}

function analyzeSecurityConfig(config) {
    const concerns = [];

    if (config.poweredByHeader !== false) {
        concerns.push({
            level: 'MOYENNE',
            type: 'EXPOSITION',
            detail: 'L\'en-t√™te X-Powered-By expose des informations sur le serveur'
        });
    }

    if (config.compress === false) {
        concerns.push({
            level: 'FAIBLE',
            type: 'PERFORMANCE',
            detail: 'La compression est d√©sactiv√©e'
        });
    }

    return concerns;
}

function analyzePerformanceConfig(config) {
    return {
        compression: config.compress !== false,
        imageOptimization: config.images !== false,
        incrementalStaticRegeneration: {
            enabled: config.revalidate !== undefined || config.isr !== false,
            interval: config.revalidate
        },
        staticPageGeneration: config.staticPageGeneration !== false,
        swcMinify: config.swcMinify !== false
    };
}

function analyzeOptimization(config) {
    return {
        minification: {
            enabled: config.swcMinify !== false,
            type: config.swcMinify === false ? 'Terser' : 'SWC'
        },
        moduleScoping: config.optimizeCss || false,
        reactRemoveProperties: config.compiler?.reactRemoveProperties || false,
        removeConsole: config.compiler?.removeConsole || false
    };
}

function formatReport(report) {
    let output = '';

    // En-t√™te
    output += chalk.blue('\nüîç RAPPORT D\'ANALYSE - Configuration Next.js\n');
    output += chalk.gray('‚ïê'.repeat(70) + '\n');

    // Section 1: Compilateur
    if (report.compiler) {
        output += chalk.yellow('\n[1] CONFIGURATION DU COMPILATEUR\n');
        output += chalk.cyan('  ‚ñ† Options\n');
        Object.entries(report.compiler.options).forEach(([key, value]) => {
            output += chalk.gray(`    ‚Ä¢ ${key}: `) + 
                     (value ? chalk.green('ACTIV√â') : chalk.red('D√âSACTIV√â')) + '\n';
        });

        output += chalk.cyan('\n  ‚ñ† Optimisation\n');
        Object.entries(report.compiler.optimization).forEach(([key, value]) => {
            output += chalk.gray(`    ‚Ä¢ ${key}: `) + 
                     (value ? chalk.green('ACTIV√â') : chalk.red('D√âSACTIV√â')) + '\n';
        });
    }

    // Section 2: Fonctionnalit√©s Exp√©rimentales
    if (report.experimental?.features.length > 0) {
        output += chalk.yellow('\n[2] FONCTIONNALIT√âS EXP√âRIMENTALES\n');
        report.experimental.features.forEach(feature => {
            const statusColor = feature.enabled ? 
                (feature.risk === 'HAUTE' ? chalk.red : chalk.yellow) : 
                chalk.gray;
            output += statusColor(`  ‚Ä¢ ${feature.name}: ${feature.enabled ? 'ACTIV√â' : 'D√âSACTIV√â'}`);
            if (feature.enabled) {
                output += chalk.red(` [Risque: ${feature.risk}]\n`);
            } else {
                output += '\n';
            }
        });

        if (report.experimental.analysis.length > 0) {
            output += chalk.cyan('\n  ‚ñ† Alertes\n');
            report.experimental.analysis.forEach(risk => {
                output += chalk.red(`    ‚ö†Ô∏è  [${risk.level}] ${risk.message}\n`);
            });
        }
    }

    // Section 3: En-t√™tes HTTP
    if (report.headers) {
        output += chalk.yellow('\n[3] CONFIGURATION DES EN-T√äTES\n');
        output += chalk.gray('  ‚Ä¢ Nombre de r√®gles: ') + 
                 chalk.white(report.headers.count) + '\n';

        if (report.headers.security.implemented.length > 0) {
            output += chalk.cyan('\n  ‚ñ† En-t√™tes de S√©curit√© Impl√©ment√©s\n');
            report.headers.security.implemented.forEach(header => {
                output += chalk.green(`    ‚úì ${header}\n`);
            });
        }

        if (report.headers.security.missing.length > 0) {
            output += chalk.cyan('\n  ‚ñ† En-t√™tes de S√©curit√© Manquants\n');
            report.headers.security.missing.forEach(header => {
                output += chalk.red(`    ‚úó ${header}\n`);
            });
        }

        if (report.headers.cors) {
            output += chalk.cyan('\n  ‚ñ† Configuration CORS\n');
            output += chalk.gray('    ‚Ä¢ Activ√©: ') + 
                     (report.headers.cors.enabled ? 
                        chalk.green('OUI') : chalk.red('NON')) + '\n';
        }
    }

    // Section 4: R√®gles de R√©√©criture
    if (report.rewrites) {
        output += chalk.yellow('\n[4] R√àGLES DE R√â√âCRITURE\n');
        output += chalk.gray('  ‚Ä¢ Type: ') + chalk.white(report.rewrites.type) + '\n';
        output += chalk.gray('  ‚Ä¢ Nombre de r√®gles: ') + 
                 chalk.white(report.rewrites.count) + '\n';

        if (report.rewrites.analysis.length > 0) {
            output += chalk.cyan('\n  ‚ñ† Risques D√©tect√©s\n');
            report.rewrites.analysis.forEach(risk => {
                output += chalk.red(`    ‚ö†Ô∏è  [${risk.level}] ${risk.message}\n`);
            });
        }
    }

    // Section 5: Performance
    output += chalk.yellow('\n[5] PERFORMANCE\n');
    const perf = report.performance;
    output += chalk.gray('  ‚Ä¢ Compression: ') + 
             (perf.compression ? chalk.green('ACTIV√â') : chalk.red('D√âSACTIV√â')) + '\n';
    output += chalk.gray('  ‚Ä¢ Optimisation des images: ') + 
             (perf.imageOptimization ? chalk.green('ACTIV√â') : chalk.red('D√âSACTIV√â')) + '\n';
    output += chalk.gray('  ‚Ä¢ Minification SWC: ') + 
             (perf.swcMinify ? chalk.green('ACTIV√â') : chalk.red('D√âSACTIV√â')) + '\n';

    // Section 6: S√©curit√©
    if (report.security.length > 0) {
        output += chalk.yellow('\n[6] ALERTES DE S√âCURIT√â\n');
        report.security.forEach(concern => {
            output += chalk.red(`  ‚ö†Ô∏è  [${concern.level}] ${concern.type}\n`);
            output += chalk.gray(`     ‚Üí ${concern.detail}\n`);
        });
    }

    output += chalk.gray('\n' + '‚ïê'.repeat(70) + '\n');
    output += chalk.blue('FIN DU RAPPORT\n');

    return output;
} 